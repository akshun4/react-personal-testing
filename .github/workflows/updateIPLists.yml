name: Update Imperva WAF Bypass IPs

on:
  push:
    paths:
      - '.github/workflows/updateIPLists.yml'
  workflow_dispatch:   

jobs:
  checkIps:
    name: Check IPs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Read JSON and extract array
        id: extract
        uses: actions/github-script@v4
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const inputFilePath = path.resolve(process.env.INPUT_FILE_PATH);
            const keyToExtract = process.env.INPUT_KEY;
            const data = JSON.parse(fs.readFileSync(inputFilePath, 'utf8'));

            // Handle nested keys
            const keys = keyToExtract.split('.');
            let extractedArray = data;
            for (let i = 0; i < keys.length; i++) {
              extractedArray = extractedArray[keys[i]];
            }
            
            console.log(`Extracted array: ${JSON.stringify(extractedArray)}`);
            core.setOutput('extractedArray', extractedArray);

        env:
          INPUT_FILE_PATH: staticwebapp.cofig.json
          INPUT_KEY: networking.allowedIpRanges

      - name: Use extracted array
        run: echo "Extracted array is ${{ steps.extract.outputs.extractedArray }}"

      - id: newAllowlistedIpList
        run: |
          response=$(curl -s --data "resp_format=json" https://my.imperva.com/api/integration/v1/ips)
          echo $response | jq '.ipRanges'
                          
      - id: equalityOfLists
        run: |
          echo [ "${{ steps.currentAllowlistedIpList.outputs }}" = "${{ steps.newAllowlistedIpList.outputs }}" ]; echo "$?" 